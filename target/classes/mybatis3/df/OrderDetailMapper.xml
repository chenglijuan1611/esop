<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="OrderDetailMapper">
	
	<!--表名 -->
	<sql id="tableName">
		mom_orderdetail
	</sql>
	
	<!-- 字段 -->
	<sql id="Field">
		MODID,	
		MOID,	
		MOTYPEID,	
		QTY,	
		MRPQTY,	
		SOTYPE,	
		DECLAREDQTY,	
		QUALIFIEDINQTY,	
		INVCODE,	
		ORDERDETAIL_ID
	</sql>
	
	<!-- 字段值 -->
	<sql id="FieldValue">
		#{MODID},	
		#{MOID},	
		#{MOTYPEID},	
		#{QTY},	
		#{MRPQTY},	
		#{SOTYPE},	
		#{DECLAREDQTY},	
		#{QUALIFIEDINQTY},	
		#{INVCODE},	
		#{ORDERDETAIL_ID}
	</sql>
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into 
	<include refid="tableName"></include>
		(
	<include refid="Field"></include>
		) values (
	<include refid="FieldValue"></include>
		)
	</insert>
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where 
			ORDERDETAIL_ID = #{ORDERDETAIL_ID}
	</delete>
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			MODID = #{MODID},
			MOID = #{MOID},
			MOTYPEID = #{MOTYPEID},
			QTY = #{QTY},
			MRPQTY = #{MRPQTY},
			SOTYPE = #{SOTYPE},
			DECLAREDQTY = #{DECLAREDQTY},
			QUALIFIEDINQTY = #{QUALIFIEDINQTY},
			INVCODE = #{INVCODE},
		ORDERDETAIL_ID = ORDERDETAIL_ID
		where 
		ORDERDETAIL_ID = #{ORDERDETAIL_ID}
	</update>
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select 
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include>
		where 
			ORDERDETAIL_ID = #{ORDERDETAIL_ID}
	</select>
	
	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include>
		where 1=1
		<if test="pd.keywords!= null and pd.keywords != ''"><!-- 关键词检索 -->
			and
				(
				<!--	根据需求自己加检索条件
					字段1 LIKE '%'+ #{pd.keywords}+'%'
					 or 
					字段2 LIKE '%'+ #{pd.keywords}+'%' 
				-->
				)
		</if>
	</select>
	
	<select id="findByMoDid" parameterType="pd" resultType="pd">
	select c.*,d.MotypeCode,d.Description 
	from mom_motype d,
	(select a.*,b.StartDate,b.DueDate from mom_orderdetail a ,mom_morder b where a.modid=#{MODid} and a.modid=b.modid) c
	 where c.MoTypeId = d.MoTypeId
	</select>
	
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		MODID,	
		MOID,	
		MOTYPEID,	
		QTY,	
		MRPQTY,	
		SOTYPE,	
		DECLAREDQTY,	
		QUALIFIEDINQTY,	
		INVCODE
		from 
		<include refid="tableName"></include>
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where 
			ORDERDETAIL_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
	
	
	<!-- 根据订单号和物料编码查找任务 -->
	<select id="queryOrderDetail" parameterType="pd" resultType="pd">
		select
		Moid,
		MODid,
		MoCode,
		MoSeq,
		startdate,
		DueDate,
		mdept,
		deptname,
		invCode,
		invName,
		invStd,
		qty ,
		DeclaredQty,
		QualifiedInQty,
		MotypeCode,
		MoTypeDesc
		from  V_mom_orderdetail 
		WHERE 
		MoCode = #{MoCode}
		and 
		invCode = #{invCode}
		and
		(CloseTime is null or CloseTime ='') 
		and
		qty != QualifiedInQty
	</select>
	
	
	<!-- 列表 -->
	<select id="orderDetaillistPage" parameterType="page" resultType="pd">
	select 
	Moid,
	MODid,
	MoCode,
	MoSeq,
	startdate,
	DueDate,
	mdept,
	deptname,
	invCode,
	invName,
	invStd,
	qty ,
	DeclaredQty,
	QualifiedInQty,
	MotypeCode,
	MoTypeDesc
	from  V_mom_orderdetail WHERE 
	(CloseTime is null or CloseTime ='') and  qty != QualifiedInQty 
	 <if test="pd.Mdept!=null and pd.Mdept!=''"><!-- 根据部门检索 -->
		and Mdept=#{pd.Mdept}
	 </if>
	 <if test="pd.invStd!=null and pd.invStd!=''"><!-- 规格型号检索 -->
		and invStd LIKE '%'+ #{pd.invStd}+'%'
	 </if>
	 <if test="pd.MoCode!=null and pd.MoCode!=''"><!-- 生产线检索 -->
		and MoCode=#{pd.MoCode}
	 </if>
	 <if test="pd.invCode!=null and pd.invCode!=''"><!-- 生产线检索 -->
		and invCode LIKE '%'+ #{pd.invCode}+'%'
	 </if>
	 <if test="pd.MoSeq!=null and pd.MoSeq!=''"><!-- 行号检索 -->
		and MoSeq=#{pd.MoSeq}
	 </if>
	<if test="pd.startdate!=null and pd.startdate!=''"><!-- ERP开始时间 -->
		and startdate &gt;= #{pd.startdate}
	</if>
	<if test="pd.DueDate!=null and pd.DueDate!=''"><!-- ERP结束时间 -->
		and startdate &lt;= #{pd.DueDate}
	</if>
    </select>
	
	<!-- 手机端查看ERP计划列表 -->
	<select id="orderDetaillistPage1" parameterType="page" resultType="pd">
	select 
	Moid,
	MODid,
	MoCode,
	MoSeq,
	CONVERT(varchar(100),startdate,23) As startdate,
	CONVERT(varchar(100),DueDate,23) As DueDate,
	mdept,
	deptname,
	invCode,
	invName,
	invStd,
	qty ,
	DeclaredQty,
	QualifiedInQty,
	MotypeCode,
	MoTypeDesc
	from  V_mom_orderdetail WHERE 
	(CloseTime is null or CloseTime ='') and  qty != QualifiedInQty
	 <if test="pd.keywords!= null and pd.keywords != ''">
		and
			(
				<!--根据需求自己加检索条件 -->
				invCode LIKE '%'+ #{pd.keywords}+'%'
				 or 
				invStd LIKE '%'+ #{pd.keywords}+'%' 
			)
	 </if> 	
	 <if test="pd.Mdept!=null and pd.Mdept!=''"><!-- 根据部门检索 -->
		and Mdept=#{pd.Mdept}
	 </if>
	 <if test="pd.invStd!=null and pd.invStd!=''"><!-- 规格型号检索 -->
		and invStd LIKE '%'+ #{pd.invStd}+'%'
	 </if>
	 <if test="pd.MoCode!=null and pd.MoCode!=''"><!-- 生产线检索 -->
		and MoCode=#{pd.MoCode}
	 </if>
	 <if test="pd.invCode!=null and pd.invCode!=''"><!-- 生产线检索 -->
		and invCode=#{pd.invCode}
	 </if>
	 <if test="pd.MoSeq!=null and pd.MoSeq!=''"><!-- 行号检索 -->
		and MoSeq=#{pd.MoSeq}
	 </if>
	<if test="pd.startTime !=null and pd.startTime !=''"><!-- ERP开始时间 -->
		and startdate &gt;= #{pd.startTime}
	</if>
	<if test="pd.endTime !=null and pd.endTime !=''"><!-- ERP结束时间 -->
		and startdate &lt;= #{pd.endTime}
	</if>
    </select>
	
	<!-- 手机端每日产量统计 -->
	<select id="countByDay" parameterType="pd" resultType="pd">
		select SUM(Qty) AS ERP_AMOUNT
		from 
		V_mom_orderdetail
		where StartDate = #{startdate} + ' 00:00:00.000'
	</select>
	<!-- rhz -->
</mapper>