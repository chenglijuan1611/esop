<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ProcessFileManagerMxMxMapper">
	
	<!--表名 -->
	<sql id="tableName">
		BASE_PROCESSFILEMANAGERMXMX
	</sql>
	
	<!-- 字段 -->
	<sql id="Field">
		STATION_NAME,	
		CLASSIFICATION,	
		PAGE,	
		PACKAGE_CHECK,	
		GLUE_SYMBOL,	
		TERMINAL_EQUIPMENT,	
		PROCESS_FILE,	
		PROCESSFILEMANAGERMXMX_ID,
		PROCESSFILEMANAGERMX_ID,
		LINE_CODE
	</sql>
	
	<!-- 字段值 -->
	<sql id="FieldValue">
		#{STATION_NAME},	
		#{CLASSIFICATION},	
		#{PAGE},	
		#{PACKAGE_CHECK},	
		#{GLUE_SYMBOL},	
		#{TERMINAL_EQUIPMENT},	
		#{PROCESS_FILE},	
		#{PROCESSFILEMANAGERMXMX_ID},
		#{PROCESSFILEMANAGERMX_ID}
		#{LINE_CODE}
	</sql>
	
	<!-- 新增-->
	<insert id="save" parameterType="pd">
		insert into 
	<include refid="tableName"></include>
		(
	<include refid="Field"></include>
		) values (
	<include refid="FieldValue"></include>
		)
	</insert>
	
	<!-- 删除-->
	<delete id="delete" parameterType="pd">
		delete from
		<include refid="tableName"></include>
		where 
			PROCESSFILEMANAGERMXMX_ID = #{PROCESSFILEMANAGERMXMX_ID}
	</delete>
	
	
	<!-- 工位信息复制之前，先删除该物料自己本身已有的工位配置-->
	<delete id="deleteBeforeCopy" parameterType="pd">
		IF EXISTS(SELECT* FROM BASE_PROCESSFILEMANAGERMXMX WHERE PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID})
		BEGIN
			delete from BASE_PROCESSFILEMANAGERMXMX where PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID}
		END	
	</delete>
	
	<!--  根据物料编码和产线和MXID信息删除上传的文件-->
	<delete id="delFile" parameterType="pd">
		delete from 
			BASE_PROCESSFILESAVE
		where  
			 MATERIAL_CODING = #{MATERIAL_CODING} and PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID}
	</delete>
	<!-- 根据物料编码和产线和MXID信息删除工位信息 -->
	<delete id="delMxMXMess" parameterType="pd">
		delete from 
			BASE_PROCESSFILEMANAGERMXMX
		where
			PROCESSFILEMANAGERMX_ID =  #{PROCESSFILEMANAGERMX_ID}
	</delete>
	
	<!-- 根据物料编码和产线和MXID信息删除工位信息1111111111111111111 -->
	<delete id="delMxMXMess1111111111" parameterType="pd">
		delete from 
			BASE_PROCESSFILEMANAGERMXMX
		where (PROCESSFILEMANAGERMX_ID =  #{PROCESSFILEMANAGERMX_ID} and LINE_CODE = #{PRODUCTLINE_NAME} )or (PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID} and TERMINAL_EQUIPMENT like '%'+#{PRODUCTLINE_NAME}+'%')
	</delete>
	
	<!-- 如果已经有相应的对照表的信息，先进行删除操作 -->
	<delete id="deleteContrastMess" parameterType="pd">
		delete from 
			BASE_PROCESSFILECONTRAST
		where 
			MATERIAL = #{PRODUCT_CODE}
	</delete>
	
	
	<!-- 删除视频存放的路径-->
	<delete id="delVideoSavePath" parameterType="pd">
		delete from 
			BASE_PROCESSFILEVIDEO
		where 
			MATERIAL = #{MATERIAL_CODING} and TERMINAL_CODE = #{terminalCode}
	</delete>
	
	<select id="delFileFind" parameterType="pd" resultType="pd">
		select count(*) zs from BASE_PROCESSFILEMANAGERMXMX where PROCESSFILEMANAGERMX_ID =
				(select  PROCESSFILEMANAGERMX_ID from BASE_PROCESSFILEMANAGERMX where MATERIAL_CODING = #{MATERIAL_CODING}) and PAGE != '0'
	</select>
	
	<!--  根据终端编码清除工位显示的页码-->
	<update id="clearStationMess" parameterType="pd">
		update
			BASE_STATIONPAGESAVE
		set 
			PAGE = #{PAGE}
		where 
			TERMINAL = #{TERMINAL} and MATERIAL_CODING = #{PRODUCT_CODE}
	</update>
	
	
	<!-- 修改 -->
	<update id="edit" parameterType="pd">
		update
		<include refid="tableName"></include>
		set 
			STATION_NAME = #{STATION_NAME},
			CLASSIFICATION = #{CLASSIFICATION},
			PAGE = #{PAGE},
			PACKAGE_CHECK = #{PACKAGE_CHECK},
			GLUE_SYMBOL = #{GLUE_SYMBOL},
			TERMINAL_EQUIPMENT = #{TERMINAL_EQUIPMENT},
			PROCESS_FILE = #{PROCESS_FILE},
			PROCESSFILEMANAGERMXMX_ID = PROCESSFILEMANAGERMXMX_ID
		where 
			PROCESSFILEMANAGERMXMX_ID = #{PROCESSFILEMANAGERMXMX_ID}
	</update>
	
	
	<!-- 上传的PDF文件转成图片后，保存图片的图片名-->
	<update id="saveContrastMess" parameterType="pd">
		INSERT INTO 
			BASE_PROCESSFILECONTRAST (CONTRAST_ID,MATERIAL,PAGE,FILENAME) 
			VALUES(#{CONTRAST_ID},#{productCode},#{page},#{filename})
	</update>
	<!-- 上传的PDF文件转成图片后，保存图片的图片名-->
	<update id="saveContrastMess2" parameterType="pd">
		INSERT INTO 
			BASE_PROCESSFILECONTRAST (CONTRAST_ID,PROCESSFILEMANAGERMX_ID,MATERIAL,PAGE,FILENAME) VALUES(#{CONTRAST_ID},#{PROCESSFILEMANAGERMX_ID},#{copyMaterial},#{page},#{filename})
	</update>
	<!-- 保存视频上传路径 -->
	<update id="videoSave" parameterType="pd">
		IF EXISTS(SELECT* FROM BASE_PROCESSFILEVIDEO WHERE MATERIAL = #{MATERIAL_CODING} and TERMINAL_CODE = #{terminalCode})
		BEGIN
			UPDATE BASE_PROCESSFILEVIDEO SET PATH = #{PATH} WHERE MATERIAL = #{MATERIAL_CODING} and TERMINAL_CODE = #{terminalCode}
		END
		ELSE
		BEGIN
			INSERT INTO BASE_PROCESSFILEVIDEO (PROCESSFILEVIDEO_ID,PROCESSFILEMANAGERMX_ID,MATERIAL,TERMINAL_CODE,PATH,UPLOAD_DATE) 
			VALUES(#{PROCESSFILEVIDEO_ID},#{PROCESSFILEMANAGERMX_ID},#{MATERIAL_CODING},#{terminalCode},#{PATH},#{UPLOAD_DATE})
		END
	</update>
	
	
	<!-- 判断数据库是否已上传过工艺文件，数据库是否已有记录 -->
	<select id="filesaveExist" parameterType="pd" resultType="pd">
		SELECT 
			* 
		FROM 
			BASE_PROCESSFILESAVE 
		WHERE 
			MATERIAL_CODING = #{PRODUCT_CODE}
	</select>
	<!-- 数据库插入工艺文件访问路径-->
	<update id="fileInsert" parameterType="pd">
		INSERT INTO 
			BASE_PROCESSFILESAVE (MATERIAL_CODING,FILE_SAVEPATH) 
			VALUES(#{PRODUCT_CODE},#{FILE_SAVEPATH})
	</update>
	<!-- 数据库更新工艺文件访问路径-->
	<update id="fileUpdate" parameterType="pd">
		UPDATE 
			BASE_PROCESSFILESAVE 
		SET 
			FILE_SAVEPATH = #{FILE_SAVEPATH} 
		WHERE 
			MATERIAL_CODING = #{MATERIAL_CODING} and PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID}
	</update>
	
	<!-- 保存文件的访问路径fileSave2 -->
	<update id="fileSave2" parameterType="pd">
		IF EXISTS(SELECT* FROM BASE_PROCESSFILESAVE WHERE MATERIAL_CODING = #{MATERIAL_CODING} and PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID})
		BEGIN
			UPDATE BASE_PROCESSFILESAVE SET FILE_SAVEPATH = #{FILE_SAVEPATH} WHERE MATERIAL_CODING = #{MATERIAL_CODING} and PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID}
		END
		ELSE
		BEGIN
			INSERT INTO BASE_PROCESSFILESAVE (MATERIAL_CODING,FILE_SAVEPATH,PROCESSFILEMANAGERMX_ID) VALUES(#{MATERIAL_CODING},#{FILE_SAVEPATH},#{PROCESSFILEMANAGERMX_ID})
		END
	</update>
	
	<!-- 判断工位是否已经有不为0的页码 -->
	<select id="pageStationExist" parameterType="pd" resultType="pd">
		SELECT 
			* 
		FROM 
			BASE_STATIONPAGESAVE 
		WHERE 
			PRODUCT_CODE = #{PRODUCT_CODE} and TERMINAL = #{TERMINAL} and PAGE != '0';
	</select>
	
	<!-- 更新工位页码显示 -->
	<update id="pageStationUpdate" parameterType="pd">
		UPDATE 
			BASE_STATIONPAGESAVE
		SET 
			PAGE = #{PAGE} 
		WHERE 
			PRODUCT_CODE = #{PRODUCT_CODE} and TERMINAL = #{TERMINAL}
	</update>
	
	<!-- 插入工位页码显示 -->
	<update id="pageStationInsert" parameterType="pd">
		INSERT INTO 
			BASE_STATIONPAGESAVE (STATIONPAGESAVE_ID,PRODUCT_CODE,PAGE,TERMINAL) 
			VALUES(#{STATIONPAGESAVE_ID},#{PRODUCT_CODE},#{PAGE},#{TERMINAL})
	</update>
	
	<!-- 根据产品查询出该产品对应的所有的图片 -->
	<select id="findPngsOfProduct" parameterType="pd" resultType="pd">
		SELECT 
			FILENAME,PAGE
		FROM 
			base_processfilecontrast 
		WHERE 
			MATERIAL = #{PRODUCTCODE}
	</select>
	
	<!--根据终端编码、物料编码，在工位信息表里查询出要显示的页码 -->
	<select id="findPageByTerminal" parameterType="pd" resultType="pd">
		select 
			*
		from 
			BASE_STATIONPAGESAVE
		where
			PRODUCT_CODE = #{PRODUCT_CODE} and TERMINAL = #{TERMINAL}
	</select>
	
	
	<!-- 通过ID获取数据 -->
	<select id="findById" parameterType="pd" resultType="pd">
		select 
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include>
		where 
			PROCESSFILEMANAGERMXMX_ID = #{PROCESSFILEMANAGERMXMX_ID}
	</select>
	
	<!-- 根据页码和material查询出来对应png的文件名 -->
	<select id="findContrastFname" parameterType="pd" resultType="pd">
		select 
			FILENAME
		from 
			BASE_PROCESSFILECONTRAST
		where 
			MATERIAL = #{PRODUCT_CODE} and PAGE = #{p}
	</select>
	
	<!-- 根据material查询出来对应的所有png的文件名 -->
	<select id="findContrastFnameList" parameterType="pd" resultType="pd">
		select 
			FILENAME
		from 
			BASE_PROCESSFILECONTRAST
		where 
			MATERIAL = #{MATERIAL_CODING}
	</select>
	
	<!-- 根据material查询出来对应的所有png的文件名 -->
	<select id="findContrastFnameList2" parameterType="pd" resultType="pd">
		select 
			FILENAME
		from 
			BASE_PROCESSFILECONTRAST
		where 
			MATERIAL = #{copyMaterial}
	</select>
	
	
	
	
	<!-- 根据物料编码和产线信息查看上传文件 -->
	<select id="findFileSavePath" parameterType="pd" resultType="pd">
		select FILE_SAVEPATH 
		from BASE_PROCESSFILESAVE
		where 
			MATERIAL_CODING = #{PRODUCT_CODE}
	</select>
	
	
	<!-- 根据物料编码和终端编码查看上传视频 -->
	<select id="findVideoSavePath" parameterType="pd" resultType="pd">
		select PATH 
		from BASE_PROCESSFILEVIDEO
		where 
			MATERIAL = #{MATERIAL_CODING} and TERMINAL_CODE = #{terminalCode}
	</select>
	<!--通过materialMxId在PROCESSFILESAVE表里查询到要复制物料的工艺文件的保存路径  -->
	<select id="findFilePathByMxId" parameterType="pd" resultType="pd">
		select 
			LINE_CODE,
			FILE_SAVEPATH 
		from 
			BASE_PROCESSFILESAVE
		where 
			PROCESSFILEMANAGERMX_ID = #{materialMxId}
	</select>
	
	
		<!--通过物料编码和产线查询是否已经配置过该物料的工艺文件显示  -->
	<select id="findMess" parameterType="pd" resultType="pd">
		select 
			PAGE
		from 
			BASE_PROCESSFILEMANAGERMXMX a,BASE_PROCESSFILEMANAGERMX b
		where 
			a.PROCESSFILEMANAGERMX_ID = b.PROCESSFILEMANAGERMX_ID and b.MATERIAL_CODING = #{MATERIAL_CODING} and a.LINE_CODE = #{PRODUCTLINE_NAME}
	</select>
	
	
	<!--通过materialMxId和linaName在PROCESSFILESAVE表里查询到要复制物料的工艺文件的保存路径   -->
	<select id="findFilePathByMxIdAndLine" parameterType="pd" resultType="pd">
		select 
			FILE_SAVEPATH 
		from 
			BASE_PROCESSFILESAVE 
		where
			PROCESSFILEMANAGERMX_ID = #{MATERIAL_COPY2}
	</select>
	
	<!-- 列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include>
		where
			PROCESSFILEMANAGERMX_ID = #{pd.PROCESSFILEMANAGERMX_ID}
		<if test="pd.keywords!= null and pd.keywords != ''"><!-- 关键词检索 -->
			and
				(
				<!--	根据需求自己加检索条件
					字段1 LIKE '%'+ #{pd.keywords}+'%'
					 or 
					字段2 LIKE '%'+ #{pd.keywords}+'%' 
				-->
				)
		</if>
	</select>
	
	
	<!--根据物料编码和产线信息查询工位信息-->
	<select id="findByProcessFileManagerMxId2" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from BASE_PROCESSFILEMANAGERMXMX
		where
		PROCESSFILEMANAGERMX_ID = (select PROCESSFILEMANAGERMX_ID from BASE_PROCESSFILEMANAGERMX where MATERIAL_CODING = #{MATERIAL_CODING} )
	</select>
	
	<!-- 根据产线查询出终端设备信息 -->
	<select id="findTerminalMess" parameterType="pd" resultType="pd">
		select 
			*
		from 
			BASE_TERMINAL
		where
			TERMINAL_TYPE = '工艺文件显示终端'
			order by CONVERT(SHOW_NUM,SIGNED)
	</select>
	
	
	<select id="findTerminalMess2" parameterType="pd" resultType="pd">
		select TERMINAL_CODE,TERMINAL_NAME,SHOW_NUM,DEPLOY_LINE
		from BASE_TERMINAL
		where
		DEPLOY_lINE = #{PRODUCTLINE_NAME} and TERMINAL_TYPE = '工艺文件显示终端'
		order by SHOW_NUM
	</select>
	
	<select id="findByProcessFileManagerMxId" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from BASE_PROCESSFILEMANAGERMXMX
		where
		LINE_CODE = #{PRODUCTLINE_NAME} and PROCESSFILEMANAGERMX_ID = (select PROCESSFILEMANAGERMX_ID from BASE_PROCESSFILEMANAGERMX where MATERIAL_CODING = #{MATERIAL_CODING} )
	</select>
	
	

	
	<!--根据终端编码、物料编码，在工位信息表里查询出要显示的页码 2222222222-->
	<select id="findPageByTerminal2" parameterType="pd" resultType="pd">
		select
			a.PAGE,
			b.PROCESSFILEMANAGERMX_ID 
		from 
			BASE_PROCESSFILEMANAGERMXMX a,BASE_PROCESSFILEMANAGERMX b
		where
			a.PROCESSFILEMANAGERMX_ID = b.PROCESSFILEMANAGERMX_ID 
			and b.MATERIAL_CODING = #{MATERIAL_CODING} 
			and a.LINE_CODE = #{PRODUCTLINE_NAME}
			and a.TERMINAL_EQUIPMENT = #{TERMINAL_CODE}
	</select>
	
<!-- 	<select id="findPageByTerminal2" parameterType="pd" resultType="pd"> -->
<!-- 		select -->
<!-- 		a.PAGE, -->
<!-- 		b.PROCESSFILEMANAGERMX_ID  -->
<!-- 		from BASE_PROCESSFILEMANAGERMXMX a,BASE_PROCESSFILEMANAGERMX b -->
<!-- 		where -->
<!-- 		a.PROCESSFILEMANAGERMX_ID = b.PROCESSFILEMANAGERMX_ID and -->
<!-- 		a.TERMINAL_EQUIPMENT = #{TERMINAL_CODE} and b.MATERIAL_CODING = #{materialId} -->
<!-- 	</select> -->
	
	<!-- 根据物料的id查询出该物料所在工艺的编码 -->
	 <select id="findProcessCodeByMxId" parameterType="pd" resultType="pd">
		select
		PROCESS_CODING 
		from BASE_PROCESSFILEMANAGER a,BASE_PROCESSFILEMANAGERMX b
		where
		a.PROCESSFILEMANAGER_ID = b.PROCESSFILEMANAGER_ID and b.PROCESSFILEMANAGER_ID = #{PROCESSFILEMANAGERMX_ID}
		TERMINAL_EQUIPMENT = #{TERMINAL_CODE} and PROCESSFILEMANAGERMX_ID = #{materialId}
	</select>
	
	<!-- 复制工位（通过materialMxId在MXMX表里查询到详细的对应终端配置信息）  -->
	 <select id="findStationMessByMxId" parameterType="pd" resultType="pd">
		select
			TERMINAL_EQUIPMENT,	
			PAGE,
			LINE_CODE
		from 
			BASE_PROCESSFILEMANAGERMX a,BASE_PROCESSFILEMANAGERMXMX b
		where 
			a.PROCESSFILEMANAGERMX_ID = b.PROCESSFILEMANAGERMX_ID and b.LINE_CODE = #{PRODUCTLINE_NAME} and a.MATERIAL_CODING = #{MATERIAL_COPY2}
<!-- 			PROCESSFILEMANAGERMX_ID = #{materialMxId} and LINE_CODE = #{PRODUCTLINE_NAME} -->
	</select>
	
	
	<!--根据MX_ID和产线查询MXMX表里是否有工位信息 -->
	<select id="findStationMessOnlyByMxId" parameterType="pd" resultType="pd">
		select
			*
		from 
			BASE_PROCESSFILEMANAGERMXMX
		where
			PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID} and LINE_CODE = #{PRODUCTLINE_NAME}
	</select>
	
	<!-- 根据物料的ID查询是否配置过工位信息 -->
	<select id="findStationMessOnlyByMxId2" parameterType="pd" resultType="pd">
		select
			*
		from 
			BASE_PROCESSFILEMANAGERMXMX
		where
			PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID}
	</select>
	
	
	<!-- 查询出某物料在哪条线上配置过终端编码   -->
	<select id="findLinesOnlyByMxId" parameterType="pd" resultType="pd">
		select
			distinct LINE_CODE
		from 
			BASE_PROCESSFILEMANAGERMXMX
		where
			PROCESSFILEMANAGERMX_ID = #{MATERIAL_COPY2}
	</select>
	
	
	
	
	<!-- 复制工位（通过materialMxId和产线在MXMX表里查询到详细的对应终端配置信息）  -->
	 <select id="findStationMessByMxIdAndLine" parameterType="pd" resultType="pd">
		select
			TERMINAL_EQUIPMENT,	
			PAGE,
			LINE_CODE
		from 
			BASE_PROCESSFILEMANAGERMX a,BASE_PROCESSFILEMANAGERMXMX b
		where
			a.PROCESSFILEMANAGERMX_ID = b.PROCESSFILEMANAGERMX_ID and LINE_CODE = #{PRODUCTLINE_NAME} and a.MATERIAL_CODING = #{MATERIAL_COPY2}
			
<!-- 			PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID} and LINE_CODE = #{PRODUCTLINE_NAME}  -->
	</select>
	
	<!-- 列表(全部) -->
	<select id="listAll" parameterType="pd" resultType="pd">
		select
		<include refid="Field"></include>
		from 
		<include refid="tableName"></include>
	</select>
	
	<!-- 批量删除 -->
	<delete id="deleteAll" parameterType="String">
		delete from
		<include refid="tableName"></include>
		where 
			PROCESSFILEMANAGERMXMX_ID in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
	</delete>
	
	<!-- 查询明细总数 -->
	<select id="findCount" parameterType="pd" resultType="pd">
		select
			count(*) zs
		from 
			<include refid="tableName"></include>
		where
			PROCESSFILEMANAGERMX_ID = #{PROCESSFILEMANAGERMX_ID} and PAGE != '0'
	</select>
		<!-- rhz -->
</mapper>